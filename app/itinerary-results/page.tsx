"use client"

import { useState, useEffect } from "react"
import { useRouter } from "next/navigation"
import Link from "next/link"
import { Button } from "../../components/ui/button"
import { Card, CardContent, CardHeader, CardTitle } from "../../components/ui/card"
import { Download, Printer, Save, RotateCcw, Plane, X, Eye } from "lucide-react"
import { useLanguageStore } from "../../lib/language-store"

// ë‹¤êµ­ì–´ ì§€ì›
const translations = {
  ko: {
    title: "ğŸ‰ ì¶”ì²œ ì—¬í–‰ ì¼ì •",
    subtitle: "AIê°€ ìƒì„±í•œ ì™„ë²½í•œ ë§ì¶¤í˜• ì—¬í–‰ ì¼ì •ì„ í™•ì¸í•˜ì„¸ìš” âœ¨",
    customSchedule: "ğŸ¯ ë‚˜ë§Œì˜ ë§ì¶¤ ì¼ì • ë§Œë“¤ê¸°",
    customScheduleDesc: "ì•„ë˜ì—ì„œ ì›í•˜ëŠ” ì—¬í–‰ì§€ì™€ ìŒì‹ì ì„ ì„ íƒí•˜ë©´, AIê°€ ìµœì ì˜ ë™ì„ ìœ¼ë¡œ ìƒˆë¡œìš´ ì¼ì •ì„ ìƒì„±í•´ë“œë¦½ë‹ˆë‹¤.",
    selectedItems: "í˜„ì¬ ì„ íƒëœ í•­ëª©",
    regenerateBtn: "âœ¨ í˜¼í•© ì¼ì • ì¬ìƒì„±í•˜ê¸°",
    itinerary1: "ğŸŒŸ ì¶”ì²œ ì¼ì • 1",
    itinerary2: "ğŸŒŸ ì¶”ì²œ ì¼ì • 2",
    detailView: "ìì„¸íˆ ë³´ê¸°",
    attractions: "ë³¼ê±°ë¦¬ (ëª…ì†Œ)",
    restaurants: "ë¨¹ê±°ë¦¬ (ìŒì‹ì  ë˜ëŠ” ìŒì‹)",
    save: "ì¼ì • ì €ì¥",
    download: "ì¼ì • ë‹¤ìš´ë¡œë“œ",
    print: "ë°”ë¡œ í”„ë¦°í„°"
  },
  en: {
    title: "ğŸ‰ Recommended Travel Itinerary",
    subtitle: "Check out the perfect customized travel itinerary generated by AI âœ¨",
    customSchedule: "ğŸ¯ Create Your Custom Itinerary",
    customScheduleDesc: "Select your desired destinations and restaurants below, and AI will generate a new itinerary with optimal routes.",
    selectedItems: "Currently selected items",
    regenerateBtn: "âœ¨ Regenerate Mixed Itinerary",
    itinerary1: "ğŸŒŸ Recommended Itinerary 1",
    itinerary2: "ğŸŒŸ Recommended Itinerary 2",
    detailView: "View Details",
    attractions: "Attractions (Places to Visit)",
    restaurants: "Food (Restaurants or Cuisine)",
    save: "Save Itinerary",
    download: "Download Itinerary",
    print: "Print Directly"
  },
  ja: {
    title: "ğŸ‰ ãŠã™ã™ã‚æ—…è¡Œãƒ—ãƒ©ãƒ³",
    subtitle: "AIãŒç”Ÿæˆã—ãŸå®Œç’§ãªã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’ã”ç¢ºèªãã ã•ã„ âœ¨",
    customSchedule: "ğŸ¯ ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ—ãƒ©ãƒ³ä½œæˆ",
    customScheduleDesc: "ä¸‹è¨˜ã‹ã‚‰å¸Œæœ›ã™ã‚‹è¦³å…‰åœ°ã¨ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚’é¸æŠã™ã‚‹ã¨ã€AIãŒæœ€é©ãªãƒ«ãƒ¼ãƒˆã§æ–°ã—ã„ãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™ã€‚",
    selectedItems: "ç¾åœ¨é¸æŠä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ",
    regenerateBtn: "âœ¨ ãƒŸãƒƒã‚¯ã‚¹ãƒ—ãƒ©ãƒ³å†ç”Ÿæˆ",
    itinerary1: "ğŸŒŸ ãŠã™ã™ã‚ãƒ—ãƒ©ãƒ³ 1",
    itinerary2: "ğŸŒŸ ãŠã™ã™ã‚ãƒ—ãƒ©ãƒ³ 2",
    detailView: "è©³ç´°è¡¨ç¤º",
    attractions: "è¦³å…‰åœ° (è¦‹ã©ã“ã‚)",
    restaurants: "ã‚°ãƒ«ãƒ¡ (ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã¾ãŸã¯æ–™ç†)",
    save: "ãƒ—ãƒ©ãƒ³ä¿å­˜",
    download: "ãƒ—ãƒ©ãƒ³ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
    print: "ç›´æ¥å°åˆ·"
  },
  zh: {
    title: "ğŸ‰ æ¨èæ—…è¡Œè¡Œç¨‹",
    subtitle: "æŸ¥çœ‹AIç”Ÿæˆçš„å®Œç¾å®šåˆ¶æ—…è¡Œè¡Œç¨‹ âœ¨",
    customSchedule: "ğŸ¯ åˆ¶å®šä¸“å±è¡Œç¨‹",
    customScheduleDesc: "ä»ä¸‹æ–¹é€‰æ‹©æ‚¨æƒ³è¦çš„æ—…æ¸¸æ™¯ç‚¹å’Œé¤å…ï¼ŒAIå°†ç”Ÿæˆæœ€ä¼˜è·¯çº¿çš„æ–°è¡Œç¨‹ã€‚",
    selectedItems: "å½“å‰é€‰æ‹©çš„é¡¹ç›®",
    regenerateBtn: "âœ¨ é‡æ–°ç”Ÿæˆæ··åˆè¡Œç¨‹",
    itinerary1: "ğŸŒŸ æ¨èè¡Œç¨‹ 1",
    itinerary2: "ğŸŒŸ æ¨èè¡Œç¨‹ 2",
    detailView: "æŸ¥çœ‹è¯¦æƒ…",
    attractions: "æ™¯ç‚¹ (è§‚å…‰åœ°)",
    restaurants: "ç¾é£Ÿ (é¤å…æˆ–æ–™ç†)",
    save: "ä¿å­˜è¡Œç¨‹",
    download: "ä¸‹è½½è¡Œç¨‹",
    print: "ç›´æ¥æ‰“å°"
  },
  vi: {
    title: "ğŸ‰ Lá»‹ch TrÃ¬nh Du Lá»‹ch Äá» Xuáº¥t",
    subtitle: "Xem lá»‹ch trÃ¬nh du lá»‹ch tÃ¹y chá»‰nh hoÃ n háº£o Ä‘Æ°á»£c táº¡o bá»Ÿi AI âœ¨",
    customSchedule: "ğŸ¯ Táº¡o Lá»‹ch TrÃ¬nh RiÃªng",
    customScheduleDesc: "Chá»n cÃ¡c Ä‘iá»ƒm Ä‘áº¿n vÃ  nhÃ  hÃ ng mong muá»‘n bÃªn dÆ°á»›i, AI sáº½ táº¡o lá»‹ch trÃ¬nh má»›i vá»›i tuyáº¿n Ä‘Æ°á»ng tá»‘i Æ°u.",
    selectedItems: "CÃ¡c má»¥c hiá»‡n Ä‘Æ°á»£c chá»n",
    regenerateBtn: "âœ¨ Táº¡o Láº¡i Lá»‹ch TrÃ¬nh Há»—n Há»£p",
    itinerary1: "ğŸŒŸ Lá»‹ch TrÃ¬nh Äá» Xuáº¥t 1",
    itinerary2: "ğŸŒŸ Lá»‹ch TrÃ¬nh Äá» Xuáº¥t 2",
    detailView: "Xem Chi Tiáº¿t",
    attractions: "Äiá»ƒm Tham Quan (Danh Lam)",
    restaurants: "áº¨m Thá»±c (NhÃ  HÃ ng hoáº·c MÃ³n Ä‚n)",
    save: "LÆ°u Lá»‹ch TrÃ¬nh",
    download: "Táº£i Lá»‹ch TrÃ¬nh",
    print: "In Trá»±c Tiáº¿p"
  },
  id: {
    title: "ğŸ‰ Itinerary Perjalanan yang Direkomendasikan",
    subtitle: "Lihat itinerary perjalanan kustom sempurna yang dibuat oleh AI âœ¨",
    customSchedule: "ğŸ¯ Buat Itinerary Pribadi",
    customScheduleDesc: "Pilih destinasi dan restoran yang diinginkan di bawah, AI akan membuat itinerary baru dengan rute optimal.",
    selectedItems: "Item yang dipilih saat ini",
    regenerateBtn: "âœ¨ Buat Ulang Itinerary Campuran",
    itinerary1: "ğŸŒŸ Itinerary Rekomendasi 1",
    itinerary2: "ğŸŒŸ Itinerary Rekomendasi 2",
    detailView: "Lihat Detail",
    attractions: "Tempat Wisata (Objek Wisata)",
    restaurants: "Kuliner (Restoran atau Masakan)",
    save: "Simpan Itinerary",
    download: "Unduh Itinerary",
    print: "Cetak Langsung"
  }
}

// ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
function DetailModal({ isOpen, onClose, title, children }: { 
  isOpen: boolean; 
  onClose: () => void; 
  title: string; 
  children: React.ReactNode;
}) {
  if (!isOpen) return null;

  const handleSaveSchedule = () => {
    alert("ì¼ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’¾")
  }

  const handleDownload = () => {
    alert("ì¼ì •ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤! ğŸ“±")
  }

  const handlePrint = () => {
    window.print()
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div className="flex justify-between items-center p-6 border-b">
          <h2 className="text-2xl font-bold">{title} - ìƒì„¸ ì •ë³´</h2>
          <Button variant="ghost" size="sm" onClick={onClose}>
            <X className="w-4 h-4" />
          </Button>
        </div>
        <div className="p-6">
          {children}
          
          {/* ëª¨ë‹¬ ë‚´ ì•¡ì…˜ ë²„íŠ¼ë“¤ */}
          <div className="flex flex-wrap gap-4 mt-6 pt-6 border-t">
            <Button onClick={handleSaveSchedule} className="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700">
              <Save className="w-4 h-4" />
              <span>ì¼ì • ì €ì¥</span>
            </Button>
            <Button onClick={handleDownload} className="flex items-center space-x-2 bg-green-600 hover:bg-green-700">
              <Download className="w-4 h-4" />
              <span>ì¼ì • ë‹¤ìš´ë¡œë“œ</span>
            </Button>
            <Button onClick={handlePrint} variant="outline" className="flex items-center space-x-2">
              <Printer className="w-4 h-4" />
              <span>ë°”ë¡œ í”„ë¦°í„°</span>
            </Button>
          </div>
        </div>
      </div>
    </div>
  )
}

export default function ItineraryResultsPage() {
  const [selectedItems, setSelectedItems] = useState<Set<string>>(new Set())
  const [modalData, setModalData] = useState<{
    isOpen: boolean;
    title: string;
    content: React.ReactNode;
  }>({
    isOpen: false,
    title: "",
    content: null
  })

  // ì—¬í–‰ ì¼ì • ë°ì´í„° ìƒíƒœ ì¶”ê°€
  const [plans, setPlans] = useState<{ plan_a: any; plan_b: any } | null>(null)

  const { language } = useLanguageStore()
  const t = translations[language as keyof typeof translations]

  const router = useRouter();
  useEffect(() => {
    const result = localStorage.getItem("itineraryResult");
    if (result) {
      try {
        const data = JSON.parse(result);
        if (data.status === "fallback" || data.error_message) {
          alert("ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ë¡œ ì¸í•´ ì—¬í–‰ ì¼ì •ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          router.replace("/create-itinerary");
        } else {
          setPlans({ plan_a: data.plan_a, plan_b: data.plan_b })
        }
      } catch (e) {
        // íŒŒì‹± ì—ëŸ¬ ë“± ì˜ˆì™¸ ë¬´ì‹œ
      }
    }
  }, [router]);

  const handleCheckboxChange = (itemId: string) => {
    const newSelected = new Set(selectedItems)
    if (newSelected.has(itemId)) {
      newSelected.delete(itemId)
    } else {
      newSelected.add(itemId)
    }
    setSelectedItems(newSelected)
  }

  const handleCreateCustomSchedule = () => {
    if (selectedItems.size === 0) {
      alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”!")
      return
    }
    alert(`ì„ íƒëœ ${selectedItems.size}ê°œ í•­ëª©ìœ¼ë¡œ ì»¤ìŠ¤í…€ ì¼ì •ì´ ìƒì„±ë©ë‹ˆë‹¤! âœ¨`)
  }

  // ì¼ì • ìƒì„¸ ëª¨ë‹¬ ë™ì  ìƒì„±
  const openModal = (title: string, content: React.ReactNode) => {
    setModalData({
      isOpen: true,
      title,
      content
    })
  }
  const closeModal = () => {
    setModalData({
      isOpen: false,
      title: "",
      content: null
    })
  }

  // ì¼ì • ìƒì„¸ ì •ë³´ ë™ì  ìƒì„± í•¨ìˆ˜
  const getDetailContent = (plan: any) => (
    <div className="space-y-6">
      {plan.daily_plans.map((day: any, idx: number) => (
        <div key={idx} className="border-b pb-4">
          <h3 className="text-xl font-bold mb-3">Day {day.day}: {day.theme}</h3>
          <div className="mb-4">
            {day.activities.map((act: any, i: number) => (
              <div key={i} className="mb-2 p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                <div className="font-semibold">{act.time} - {act.activity}</div>
                <div className="text-sm text-gray-600 dark:text-gray-300">{act.location} | {act.description}</div>
                <div className="text-xs text-gray-400">{act.duration} {act.cost && `| ë¹„ìš©: ${act.cost}`}</div>
                {act.tips && <div className="text-xs text-green-600">Tip: {act.tips}</div>}
              </div>
            ))}
          </div>
          {day.meals && (
            <div className="text-xs text-gray-500 mb-2">ğŸ½ï¸ ì‹ì‚¬: {Object.entries(day.meals).map(([k, v]) => `${k}: ${v}`).join(", ")}</div>
          )}
          {day.transportation && (
            <div className="text-xs text-gray-500 mb-2">ğŸš— ì´ë™: {day.transportation.join(", ")}</div>
          )}
          {day.estimated_cost && (
            <div className="text-xs text-gray-500 mb-2">ğŸ’¸ ì˜ˆìƒë¹„ìš©: {day.estimated_cost}</div>
          )}
        </div>
      ))}
    </div>
  )

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-green-50 dark:from-gray-900 dark:via-purple-900/20 dark:to-blue-900/20 py-12">
      <div className="container mx-auto px-4">
        <div className="text-center mb-8">
          <Link href="/" className="flex items-center justify-center space-x-3 mb-8">
            <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center">
              <Plane className="w-6 h-6 text-white transform rotate-45" />
            </div>
            <span className="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
              Plan Go
            </span>
          </Link>
          <h1 className="text-5xl font-bold mb-6 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
            {t.title}
          </h1>
          <p className="text-xl text-gray-600 dark:text-gray-300 mb-8">{t.subtitle}</p>
          
          {/* í˜¼í•© ì¼ì • ìƒì„± ì„¹ì…˜ì„ ìƒë‹¨ìœ¼ë¡œ ì´ë™ - í•­ìƒ í‘œì‹œ */}
                      <div className="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-2xl p-6 shadow-xl mb-8">
              <div className="mb-4">
                <h2 className="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-2">
                  {t.customSchedule}
                </h2>
                <p className="text-gray-600 dark:text-gray-300">
                  {t.customScheduleDesc}
                </p>
                <span className="inline-block mt-3 text-lg font-semibold text-purple-600 dark:text-purple-400">
                  {t.selectedItems}: {selectedItems.size}ê°œ
                </span>
              </div>
              <Button 
                onClick={handleCreateCustomSchedule}
                className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-8 py-3 text-lg shadow-xl"
              >
                {t.regenerateBtn}
              </Button>
            </div>
        </div>

        <div className="grid lg:grid-cols-2 gap-8">
          {/* Itinerary 1 */}
          {plans && plans.plan_a && (
            <Card className="shadow-2xl border-0 bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm">
              <CardHeader className="bg-gradient-to-r from-blue-500 to-purple-500 text-white">
                <CardTitle className="text-3xl text-center">{t.itinerary1}</CardTitle>
                <div className="mt-4 p-4 bg-white/20 rounded-lg">
                  <h4 className="font-bold text-lg mb-3">{plans.plan_a.title}</h4>
                  <div className="mb-2 text-base">{plans.plan_a.concept}</div>
                </div>
              </CardHeader>
              <CardContent className="space-y-8 p-6">
                <Button onClick={() => openModal(t.itinerary1, getDetailContent(plans.plan_a))} variant="outline" size="sm" className="flex items-center space-x-2">
                  <Eye className="w-4 h-4" />
                  <span>{t.detailView}</span>
                </Button>
                {/* ì¼ì • ìš”ì•½ ë¦¬ìŠ¤íŠ¸ */}
                {plans.plan_a.daily_plans.map((day: any, idx: number) => (
                  <div key={idx} className="mb-6">
                    <div className="font-bold text-lg mb-2">Day {day.day}: {day.theme}</div>
                    <ul className="list-disc ml-6">
                      {day.activities.map((act: any, i: number) => (
                        <li key={i}>{act.time} - {act.activity} ({act.location})</li>
                      ))}
                    </ul>
                  </div>
                ))}
              </CardContent>
            </Card>
          )}
          {/* Itinerary 2 */}
          {plans && plans.plan_b && (
            <Card className="shadow-2xl border-0 bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm">
              <CardHeader className="bg-gradient-to-r from-green-500 to-teal-500 text-white">
                <CardTitle className="text-3xl text-center">{t.itinerary2}</CardTitle>
                <div className="mt-4 p-4 bg-white/20 rounded-lg">
                  <h4 className="font-bold text-lg mb-3">{plans.plan_b.title}</h4>
                  <div className="mb-2 text-base">{plans.plan_b.concept}</div>
                </div>
              </CardHeader>
              <CardContent className="space-y-8 p-6">
                <Button onClick={() => openModal(t.itinerary2, getDetailContent(plans.plan_b))} variant="outline" size="sm" className="flex items-center space-x-2">
                  <Eye className="w-4 h-4" />
                  <span>{t.detailView}</span>
                </Button>
                {/* ì¼ì • ìš”ì•½ ë¦¬ìŠ¤íŠ¸ */}
                {plans.plan_b.daily_plans.map((day: any, idx: number) => (
                  <div key={idx} className="mb-6">
                    <div className="font-bold text-lg mb-2">Day {day.day}: {day.theme}</div>
                    <ul className="list-disc ml-6">
                      {day.activities.map((act: any, i: number) => (
                        <li key={i}>{act.time} - {act.activity} ({act.location})</li>
                      ))}
                    </ul>
                  </div>
                ))}
              </CardContent>
            </Card>
          )}
        </div>
        {/* ëª¨ë‹¬ */}
        <DetailModal 
          isOpen={modalData.isOpen}
          onClose={closeModal}
          title={modalData.title}
        >
          {modalData.content}
        </DetailModal>
      </div>
    </div>
  )
}
